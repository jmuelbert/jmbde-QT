<?xml version='1.0' encoding='windows-1252'?>
<Wix xmlns='http://schemas.microsoft.com/wix/2006/wi'>

    <?define ProductName = "jmbde" ?>
    <?define Manufacturer = "Jürgen Mülbert" ?>
    <?define UpgradeCode = "6D266744-D1FA-4FB6-A903-55151AD82730" ?>
    <?define WebsiteURL = "http://jmuelbert.github.io/jmbde-QT/" ?>

    
    <?ifndef InstallRoot ?>
        <?error InstallRoot must be defined ?>
    <?endif?>
    <?ifndef QtDir ?>
        <?error QtDir must be defined ?>
    <?endif?>
    <?ifndef RootDir ?>
        <?error RootDir must be defined ?>
    <?endif?>
    <?ifndef Version ?>
        <?error Version must be defined ?>
    <?endif?>
    <?ifndef Platform ?>
        <?error Platform must be defined ?>
    <?endif?>

    <?if $(var.Platform) = x64 ?>
        <?define PlatformProgramFilesFolder = "ProgramFiles64Folder" ?>
    <?else ?>
        <?define PlatformProgramFilesFolder = "ProgramFilesFolder" ?>
    <?endif ?>

    <Product Name='$(var.ProductName)' Id="*"
            UpgradeCode="$(var.UpgradeCode)"
            Language='1033' Codepage='1252'
            Version='$(var.Version)'
            Manufacturer='$(var.Manufacturer)'>

    
        <Package Id='*' Keywords='Installer' Description="[ProductName] Installer" 
                    Comments='Windows Installer Package' Manufacturer='[Manufacturer]' 
                    Languages='1033' Compressed='yes' SummaryCodepage='1252' 
                    InstallScope='perMachine' />

            <MajorUpgrade AllowDowngrades="yes" />

      
            <!-- Set properties for add/remove programs -->
            <Property Id="ARPPRODUCTICON" Value="jmbde.exe" />
            <Property Id="ARPURLINFOABOUT" Value="$(var.WebsiteURL)" />
            <Property Id="ARPNOREPAIR" Value="yes" Secure="yes" /> <!-- Remove repair -->          

            <Media Id='1' Cabinet='files.cab' EmbedCab='yes' DiskPrompt="CD-ROM #1" CompressionLevel="high" />
            <Property Id='DiskPrompt' Value="jmbde Installation [1]" />

            <!-- Save the command line value INSTALLDIR and restore it later in the sequence or it will be overwritten by the value saved to the registry during an upgrade -->
            <!-- http://robmensching.com/blog/posts/2010/5/2/the-wix-toolsets-remember-property-pattern/ -->
            <CustomAction Id='SaveCmdLineValueINSTALLDIR' Property='CMDLINE_INSTALLDIR' Value='[INSTALLDIR]' Execute='firstSequence' />
            <CustomAction Id='SetFromCmdLineValueINSTALLDIR' Property='INSTALLDIR' Value='[CMDLINE_INSTALLDIR]' Execute='firstSequence' />
            <InstallUISequence>
                <Custom Action='SaveCmdLineValueINSTALLDIR' Before='AppSearch' />
                <Custom Action='SetFromCmdLineValueINSTALLDIR' After='AppSearch'>
                    CMDLINE_INSTALLDIR      
                </Custom>
            </InstallUISequence>
            <InstallExecuteSequence>
                <Custom Action='SaveCmdLineValueINSTALLDIR' Before='AppSearch' />
                <Custom Action='SetFromCmdLineValueINSTALLDIR' After='AppSearch'>
                    CMDLINE_INSTALLDIR      
                </Custom>
            </InstallExecuteSequence>

            <Property Id="INSTALLDIR">
                <RegistrySearch Id='DetermineInstallLocation' Type='raw' Root='HKLM' Key='Software\[Manufacturer]\[ProductName]' Name='InstallDir' />
            </Property>

            <Directory Id='TARGETDIR' Name='SourceDir'>

                <Directory Id='$(var.PlatformProgramFilesFolder)' Name='PFiles'>
                    <Directory Id='INSTALLDIR' Name='jmbde'>

                        <Component Id='MainExecutable' Guid='{E263E7C9-DDBE-467A-B4E2-C3EB07140527}'>
                            <File Id='jmbdeEXE' Source='$(var.InstallRoot)\jmbde.exe'>
                                <Shortcut Id="startmenuJMBDE" Directory="ProgramMenuFolder" Name="jmbde" WorkingDirectory='INSTALLDIR' Icon="jmbde.exe" IconIndex="0" Advertise="yes" />
                                <Shortcut Id="desktopJMBDE" Directory="DesktopFolder" Name="jmbde" WorkingDirectory='INSTALLDIR' Icon='jmbde.exe' IconIndex="0" Advertise="yes" />
                            </File>

                            <!-- libs/dlls -->
                            <file Id="c34167e695754794969fcb610bdec48e" Source="$(var.InstallRoot)\jmbde.dll" />
                           
                            <!-- qtconf -->
                            <File Id="qt_conf" Source="$(var.RootDir)\dist\win\qt.conf" />
                            <File Id="Qt5Core_dll" Source="$(var.QtDir)\bin\Qt5Core.dll" />
                            <File Id="Qt5Gui_dll" Source="$(var.QtDir)\bin\Qt5Gui.dll" />
                            <File Id="Qt5Help_dll" Source="$(var.QtDir)\bin\Qt5Help.dll" />
                            <File Id="Qt5PrintSupport_dll" Source="$(var.QtDir)\bin\Qt5PrintSupport.dll" />                            
                            <File Id="Qt5Sql_dll" Source="$(var.QtDir)\bin\Qt5Sql.dll" />
                            <File Id="Qt5Svg_dll" Source="$(var.QtDir)\bin\Qt5Svg.dll" />
                            <File Id="Qt5Widgets_dll" Source="$(var.QtDir)\bin\Qt5Widgets.dll" />
                            <File Id="d3compiler_dll" Source="$(var.QtDir)\bin\d3compiler_47.dll" />
                            <File Id="libEGL_dll" Source="$(var.QtDir)\bin\libEGL.dll" />
                            <File Id="libBGLESV2_dll" Source="$(var.QtDir)\bin\libGLESV2.dll" />
                            <File Id="opengl32sw_dll" Source="$(var.QtDir)\bin\opengl32sw.dll" />
             
                            <?ifdef MingwDir ?>
                                <File Id="libgcc_s_dw2_1_dll" Source="$(var.MingwDir)\bin\libgcc_s_dw2-1.dll"/>
                                <File Id="libstdc___6_dll" Source="$(var.MingwDir)\bin\libstdc++-6.dll"/>
                                <File Id="libwinpthread_1_dll" Source="$(var.MingwDir)\bin\libwinpthread-1.dll"/>
                            <?else?>
                                <File Source="$(var.VcInstallDir)\redist\$(var.Platform)\Microsoft.VC140.CRT\msvcp140.dll"/>
                                <File Source="$(var.VcInstallDir)\redist\$(var.Platform)\Microsoft.VC140.CRT\vccorlib140.dll"/>
                                <File Source="$(var.VcInstallDir)\redist\$(var.Platform)\Microsoft.VC140.CRT\vcruntime140.dll"/>
                            <?endif?>

                            <File Id="LICENSE_EUPL_EN" Name="License.txt" Source="$(var.RootDir)\LICENSE" />
                            <File Id="LICENSE_EUPL_DE" Name="License_DE.txt" Source="$(var.RootDir)\LICENSE.EUPL_1_2" />
                            <File Id="AUTHORS" Name="Authors.txt" Source="$(var.RootDir)\AUTHORS" />
                            <File Id="README" Name="README.txt" Source="$(var.RootDir)\README.md" />
                            <File Id="NEWS" Name="NEWS.txt" Source="$(var.RootDir)\NEWS.md" />

                            <RegistryKey Root='HKLM' Key='Software\[Manufacturer]\[ProductName]'>
                                <RegistryValue Type='string' Name='InstallDir' Value='[INSTALLDIR]'/>
                            </RegistryKey>
                        </Component>

                        <Directory Id="dir4B4EC78E44A14E3586DBB582DEE9DB20" Name="plugins">
                            <Directory Id="dir9161b681077a40d68ac660a9b0eb3ad3" Name="jmbde">
                                <Component Id="Plugins" Guid="{9158E791-DAE3-4D08-99BA-04F421CB6F19}">
                                    <!-- File Id="GUID" Source="$(var.InstallRoot)\plugins\jmbde\plugin.dll" / -->
                                </Component>
                            </Directory>
                            <Directory Id="platformPlugins" Name="platforms">
                                <Component Id="PlatformPlugins" Guid="{F3CB8779-86F5-4E18-A68D-83A2C284F8E5}" >
                                    <File Id="qwindows.dll" Source="$(var.QtDir)\plugins\platforms\qwindows.dll" />
                                </Component>
                            </Directory>

                            <Directory Id="iconenginesPlugins" Name="iconengines">
                                <Component Id="IconEnginesPlugins" Guid="{5D6C69C7-8CAE-4060-98ED-F8C304902D20}">
                                    <File Id="qsvgicon_dll" Source="$(var.QtDir)\plugins\iconengines\qsvg.dll"/>
                                </Component>
                            </Directory>

                            <Directory Id="imageFormatPlugins" Name="imageformats">
                                <Component Id="ImageFormatPlugins" Guid="{37C07FF9-D655-4E31-A2CC-780592865096}">
                                    <File Id="qgif_dll" Source="$(var.QtDir)\plugins\imageformats\qgif.dll"/>
                                    <File Id="qicns_dll" Source="$(var.QtDir)\plugins\imageformats\qicns.dll"/>
                                    <File Id="qico_dll" Source="$(var.QtDir)\plugins\imageformats\qico.dll"/>
                                    <File Id="qjpeg_dll" Source="$(var.QtDir)\plugins\imageformats\qjpeg.dll"/>
                                    <File Id="qsvg_dll" Source="$(var.QtDir)\plugins\imageformats\qsvg.dll"/>
                                    <File Id="qtga_dll" Source="$(var.QtDir)\plugins\imageformats\qtga.dll"/>
                                    <File Id="qtiff_dll" Source="$(var.QtDir)\plugins\imageformats\qtiff.dll"/>
                                    <File Id="qwbmp_dll" Source="$(var.QtDir)\plugins\imageformats\qwbmp.dll"/>
                                    <File Id="qwebp_dll" Source="$(var.QtDir)\plugins\imageformats\qwebp.dll"/>
                                </Component>
                            </Directory>

                            <Directory Id="printSupportPlugins" Name="printsupport">
                                <Component Id="PrintSupportPlugin" Guid="{29A6CEEA-C311-4CAA-AC42-C0BC6CBB6257}">
                                    <File Id="windowsprintersupport_dll" Source="$(var.QtDir)\plugins\printsupport\windowsprintersupport.dll"/>
                                </Component>
                            </Directory>

                            <Directory Id="sqlDriversPlugins" Name="sqldrivers">
                                <Component Id="SqlDriversSupport" Guid="{0D10DC6F-85B8-40B3-9D2B-317F0918A607}">
                                    <File Id="qsqlite_dll" Source="$(var.QtDir)\plugins\sqldrivers\qsqlite.dll"/>
                                    <File Id="qsqlmysql_dll" Source="$(var.QtDir)\plugins\sqldrivers\qsqlmysql.dll"/>
                                    <File Id="qsqlodbc_dll" Source="$(var.QtDir)\plugins\sqldrivers\qsqlodbc.dll"/>
                                    <File Id="qsqlpsql_dll" Source="$(var.QtDir)\plugins\sqldrivers\qsqlpsql.dll"/>                                    
                                </Component>
                            </Directory>
                                 
                            <Directory Id="stylesPlugins" Name="styles">
                                <Component Id="StylesSupport" Guid="{90554436-C14D-46ED-B476-547D703BF402}">
                                    <File Id="qwindowsvistastyle_dll" Source="$(var.QtDir)\plugins\styles\qwindowsvistastyle.dll"/>
                                </Component>
                            </Directory>
                        </Directory>

                        <Directory Id="dir6E58B1622E344FC2B49EAA9F8B894AD8" Name="translations">
                            <Component Id="Translations" Guid="{C76FBA95-EB3D-46C2-9605-476B079ACCDE}">
                                <!-- jmbde Translations -->              
                                <File Id="filFAE97ACF001B46DCBAD41A4FBF49F498" Source="$(var.InstallRoot)\translations\jmbde_ar_DZ.qm" />
                                <File Id="fil95473CC846DF491BBCC4DDC31016CD5C" Source="$(var.InstallRoot)\translations\jmbde_bg.qm" />
                                <File Id="filF3DA65C246324AE9B47F6ECBB76AEDF6" Source="$(var.InstallRoot)\translations\jmbde_cs.qm" />
                                <File Id="fil8D73250F770F4BC68245A866C81FA02C" Source="$(var.InstallRoot)\translations\jmbde_de.qm" />
                                <File Id="fil21DD13DE620149849311C80078F82985" Source="$(var.InstallRoot)\translations\jmbde_en.qm" />
                                <File Id="filAFE9F2AD3C8248C689FC7C9091C9EDCB" Source="$(var.InstallRoot)\translations\jmbde_es.qm" />
                                <File Id="fil15627A38F4CF4139ACC21BB8C00CF9D0" Source="$(var.InstallRoot)\translations\jmbde_fr.qm" />
                                <File Id="filAD4CF109CFC54537925214F7599A87A8" Source="$(var.InstallRoot)\translations\jmbde_he.qm" />
                                <File Id="filDE5712E69E0E4919819EA1BE1B5A3197" Source="$(var.InstallRoot)\translations\jmbde_it.qm" />
                                <File Id="fil20035C47A2C24546A01CE317D7C59EF8" Source="$(var.InstallRoot)\translations\jmbde_ja.qm" />
                                <File Id="filEEE275BDD0324B20891A5D71F1DE2781" Source="$(var.InstallRoot)\translations\jmbde_nb.qm" />
                                <File Id="filFE9744BA9969468888FEB71E5413E500" Source="$(var.InstallRoot)\translations\jmbde_nl.qm" />
                                <File Id="filF7E25D0A42864D5B897D94D093BB6F1E" Source="$(var.InstallRoot)\translations\jmbde_pl.qm" />
                                <File Id="filA52BE6B3BB194074AD4093141FFC962E" Source="$(var.InstallRoot)\translations\jmbde_pt.qm" />
                                <File Id="fil433A9E290BC5481785CA08CF5562B98D" Source="$(var.InstallRoot)\translations\jmbde_pt_PT.qm" />
                                <File Id="fil06c3bab056a34f5b9941b1f743e714c6" Source="$(var.InstallRoot)\translations\jmbde_ru.qm" />
                                <File Id="fil9BEAC97D9B684A21A03BE12084C28C45" Source="$(var.InstallRoot)\translations\jmbde_tr.qm" />
                                <File Id="filB0BC755DC88649EFB339B858F549E75D" Source="$(var.InstallRoot)\translations\jmbde_zh.qm" />
                                <File Id="filD1308BB6A2694829831D5A13E05F5184" Source="$(var.InstallRoot)\translations\jmbde_zh_TW.qm" />

                                <!-- Qt translations -->
                                <File Id="qt_bg" Source="$(var.QtDir)\translations\qt_bg.qm"/>
                                <File Id="qt_ca" Source="$(var.QtDir)\translations\qt_ca.qm"/>
                                <File Id="qt_cs" Source="$(var.QtDir)\translations\qt_cs.qm"/>
                                <File Id="qt_da" Source="$(var.QtDir)\translations\qt_da.qm"/>
                                <File Id="qt_de" Source="$(var.QtDir)\translations\qt_de.qm"/>
                                <File Id="qt_en" Source="$(var.QtDir)\translations\qt_en.qm"/>
                                <File Id="qt_es" Source="$(var.QtDir)\translations\qt_es.qm"/>
                                <File Id="qt_fi" Source="$(var.QtDir)\translations\qt_fi.qm"/>
                                <File Id="qt_fr" Source="$(var.QtDir)\translations\qt_fr.qm"/>
                                <File Id="qt_gd" Source="$(var.QtDir)\translations\qt_gd.qm"/>
                                <File Id="qt_he" Source="$(var.QtDir)\translations\qt_he.qm"/>
                                <File Id="qt_hu" Source="$(var.QtDir)\translations\qt_hu.qm"/>
                                <File Id="qt_it" Source="$(var.QtDir)\translations\qt_it.qm"/>
                                <File Id="qt_ja" Source="$(var.QtDir)\translations\qt_ja.qm"/>
                                <File Id="qt_ko" Source="$(var.QtDir)\translations\qt_ko.qm"/>
                                <File Id="qt_lv" Source="$(var.QtDir)\translations\qt_lv.qm"/>
                                <File Id="qt_pl" Source="$(var.QtDir)\translations\qt_pl.qm"/>
                                <File Id="qt_ru" Source="$(var.QtDir)\translations\qt_ru.qm"/>
                                <File Id="qt_uk" Source="$(var.QtDir)\translations\qt_uk.qm"/>
                            </Component>
                        </Directory>
                    </Directory>
                </Directory>    
                <!-- End of ProgramFilesFolder -->

                <!-- Begin of ProgramMenuFolder -->
                <Directory Id="ProgramMenuFolder" Name="Programs">
                    <Component Id="ProgramMenuDir" Guid="{244A93CA-0235-495E-A758-7FFCF1937289}">
                        <RegistryValue Root='HKMU' Key='Software\[Manufacturer]\[ProductName]' Type='string' Value='' KeyPath='yes' />
                    </Component>
                </Directory>

                <Directory Id="DesktopFolder" Name="Desktop" />
            </Directory>

            <!-- Begin of Features -->
            <Feature Id='Complete' Level='1' Title="jmbde" Description="The complete package." ConfigurableDirectory='INSTALLDIR' AllowAdvertise='no' Absent='disallow'>
                <ComponentRef Id='MainExecutable' /> 
                <ComponentRef Id='Plugins' />
                <ComponentRef Id='Translations' />
                <ComponentRef Id='PlatformPlugins' />
                <ComponentRef Id='IconEnginesPlugins' />
                <ComponentRef Id='ImageFormatPlugins' />
                <CompoqnentRef Id='PrintSupportPlugins' />
                <ComponentRef Id='SqlDriverPlugins' /> 
                <ComponentRef Id='StylesPlugins' />
                <ComponentRef Id='ProgramMenuDir' /> 
            </Feature>

    
            <!-- Set up ARPINSTALLLOCATION property (http://blogs.technet.com/b/alexshev/archive/2008/02/09/from-msi-to-wix-part-2.aspx) -->
            <CustomAction Id="SetARPINSTALLLOCATION" Property="ARPINSTALLLOCATION" Value="[INSTALLDIR]" />
            <CustomAction Id='LaunchApplication' FileKey='jmbdeEXE' ExeCommand='' Return='asyncNoWait' />                                          

            <Property Id="WIXUI_INSTALLDIR">INSTALLDIR</Property>
            <UIRef Id="WixUI_InstallDir" />
            <UIRef Id="WixUI_ErrorProgressText" />

            <Icon Id="jmbde.exe" SourceFile="$(var.InstallRoot)\jmbde.exe" />
  
     
            <WixVariable Id="WixUILicenseRtf" Value="$(var.RootDir)\dist\win\eupl-1.2.rtf" />
            <WixVariable Id="WixUIBannerBmp" Value="$(var.RootDir)\dist\win\banner.bmp" />
            <WixVariable Id="WixUIDialogBmp" Value="$(var.RootDir)\dist\win\dialog.bmp" />

            <InstallExecuteSequence>
            <!-- Determine the install location after the install path has been validated by the installer -->
            <Custom Action="SetARPINSTALLLOCATION" After="InstallValidate"></Custom>
            <Custom Action='LaunchApplication' After='InstallFinalize'>NOT Installed</Custom>
        </InstallExecuteSequence>
    </Product>
</Wix>    