<?xml version='1.0' encoding='windows-1252'?>
<Wix xmlns='http://schemas.microsoft.com/wix/2006/wi'>

  <?define ProductName = "jmbde" ?>
  <?define Manufacturer = "Jürgen Mülbert" ?>
  <?define UpgradeCode = "dbfeae14-c49f-4ca0-bccc-fa4203420eac" ?>
  <?define WebsiteURL="http://github.com/jmuelbert/jmbde-QT" ?>

  <?ifndef InstallRoot ?>
  <?error InstallRoot must be defined ?>
  <?endif?>
  <?ifndef QtDir ?>
  <?error QtDir must be defined ?>
  <?endif?>
  <?ifndef RootDir ?>
  <?error RootDir must be defined ?>
  <?endif?>
  <?ifndef Version ?>
  <?error Version must be defined ?>
  <?endif?>
  <?ifndef Platform ?>
  <?error Platform must be defined ?>
  <?endif?>

  <?if $(var.Platform) = x64 ?>
  <?define PlatformProgramFilesFolder = "ProgramFiles64Folder" ?>
  <?else ?>
  <?define PlatformProgramFilesFolder = "ProgramFilesFolder" ?>
  <?endif ?>

  <Product Name='$(var.ProductName)' Id="*"
           UpgradeCode="$(var.UpgradeCode)"
           Language='1033' Codepage='1252' Version='$(var.Version)' Manufacturer='$(var.Manufacturer)'>

    <Package Id='*' Keywords='Installer' Description="[ProductName] Installer"
             Comments='Windows Installer Package' Manufacturer='[Manufacturer]'
             Languages='1033' Compressed='yes' SummaryCodepage='1252'
             InstallScope='perMachine' />

    <MajorUpgrade AllowDowngrades="yes" />

    <!-- Set properties for add/remove programs -->
    <Property Id="ARPPRODUCTICON" Value="jmbde.exe" />
    <Property Id="ARPURLINFOABOUT" Value="$(var.WebsiteURL)" />
    <Property Id="ARPNOREPAIR" Value="yes" Secure="yes" />      <!-- Remove repair -->

    <Media Id='1' Cabinet='files.cab' EmbedCab='yes' DiskPrompt="CD-ROM #1" CompressionLevel="high" />
    <Property Id='DiskPrompt' Value="JMBDE Installation [1]" />

    <!-- Save the command line value INSTALLDIR and restore it later in the sequence or it will be overwritten by the value saved to the registry during an upgrade -->
    <!-- http://robmensching.com/blog/posts/2010/5/2/the-wix-toolsets-remember-property-pattern/ -->
    <CustomAction Id='SaveCmdLineValueINSTALLDIR' Property='CMDLINE_INSTALLDIR' Value='[INSTALLDIR]' Execute='firstSequence' />
    <CustomAction Id='SetFromCmdLineValueINSTALLDIR' Property='INSTALLDIR' Value='[CMDLINE_INSTALLDIR]' Execute='firstSequence' />
    <InstallUISequence>
      <Custom Action='SaveCmdLineValueINSTALLDIR' Before='AppSearch' />
      <Custom Action='SetFromCmdLineValueINSTALLDIR' After='AppSearch'>
        CMDLINE_INSTALLDIR
      </Custom>
    </InstallUISequence>
    <InstallExecuteSequence>
      <Custom Action='SaveCmdLineValueINSTALLDIR' Before='AppSearch' />
      <Custom Action='SetFromCmdLineValueINSTALLDIR' After='AppSearch'>
        CMDLINE_INSTALLDIR
      </Custom>
    </InstallExecuteSequence>

    <Property Id="INSTALLDIR">
      <RegistrySearch Id='DetermineInstallLocation' Type='raw' Root='HKLM' Key='Software\[Manufacturer]\[ProductName]' Name='InstallDir' />
    </Property>

    <Directory Id='TARGETDIR' Name='SourceDir'>
      <Directory Id='$(var.PlatformProgramFilesFolder)' Name='PFiles'>
        <Directory Id='INSTALLDIR' Name='jmbde'>

          <Component Id='MainExecutable' Guid='{b85989b0-5433-4ff1-8eaa-66e23df2b629}'>
            <File Id='JMBDEEXE' Source='$(var.InstallRoot)\jmbde.exe' KeyPath='yes'>
              <Shortcut Id="startmenuJMBDE" Directory="ProgramMenuFolder" Name="jmbde" WorkingDirectory='INSTALLDIR' Icon="jmbde.exe" IconIndex="0" Advertise="yes" />
              <Shortcut Id="desktopJMBDE" Directory="DesktopFolder" Name="jmbde" WorkingDirectory='INSTALLDIR' Icon="jmbde.exe" IconIndex="0" Advertise="yes" />
            </File>
            <File Id="qt_conf" Source="$(var.RootDir)\dist\win\qt.conf" />
            <File Id="Qt5Core_dll" Source="$(var.QtDir)\bin\Qt5Core.dll"/>
            <File Id="Qt5Gui_dll" Source="$(var.QtDir)\bin\Qt5Gui.dll"/>
            <File Id="Qt5Network_dll" Source="$(var.QtDir)\bin\Qt5Network.dll"/>
            <File Id="Qt5Widgets_dll" Source="$(var.QtDir)\bin\Qt5Widgets.dll"/>

            <?ifdef MingwDir ?>
            <File Id="libgcc_s_dw2_1_dll" Source="$(var.MingwDir)\bin\libgcc_s_dw2-1.dll"/>
            <File Id="libstdc___6_dll" Source="$(var.MingwDir)\bin\libstdc++-6.dll"/>
            <File Id="libwinpthread_1_dll" Source="$(var.MingwDir)\bin\libwinpthread-1.dll"/>
            <?else?>
            <File Source="$(var.VcInstallDir)\redist\$(var.Platform)\Microsoft.VC120.CRT\msvcp120.dll"/>
            <File Source="$(var.VcInstallDir)\redist\$(var.Platform)\Microsoft.VC120.CRT\msvcr120.dll"/>
            <?endif?>


            <File Id="COPYING" Name="COPYING.txt" Source="$(var.RootDir)\COPYING"/>
            <File Id="AUTHORS" Name="AUTHORS.txt" Source="$(var.RootDir)\AUTHORS"/>
            <File Id="README" Name="README.txt" Source="$(var.RootDir)\README.md"/>
            <File Id="NEWS" Name="NEWS.txt" Source="$(var.RootDir)\NEWS.md"/>
            <File Id="LICENSE_APACHE" Name="LICENSE.APACHE.txt" Source="$(var.RootDir)\LICENSE.APACHE"/>
            <File Id="LICENSE_BSD" Name="LICENSE.BSD.txt" Source="$(var.RootDir)\LICENSE.BSD"/>
            <File Id="LICENSE_GPL" Name="LICENSE.GPL.txt" Source="$(var.RootDir)\LICENSE.GPL"/>
            <File Id="LICENSE_EUPL" Name="LICENSE.EUPL.txt" Source="$(var.RootDir)\LICENSE.EUPL" />
            <RegistryKey Root='HKLM' Key='Software\[Manufacturer]\[ProductName]'>
              <RegistryValue Type='string' Name='InstallDir' Value='[INSTALLDIR]'/>
            </RegistryKey>
          </Component>

          <Directory Id="dir83A7B7C3F39E24970C38654C9B6F4A12" Name="plugins">
            <Directory Id="dirED990048BCB522432182867E2817CD9B" Name="jmbde">
              <Component Id="Plugins" Guid="{05df70d9-37ac-4494-aee9-f21a1a4069eb}">

                <?ifdef Python ?>
                <File Id="fil89F906FEF817FD158A58A494F40E605A" Source="$(var.InstallRoot)\plugins\tiled\python.dll" />
                <?endif?>

              </Component>
            </Directory>
            <Directory Id="platformPlugins" Name="platforms">
              <Component Id="PlatformPlugins" Guid="{3d582fca-92c7-485f-bc6f-1ad028bfdd85}">
                <File Id="qwindows_dll" Source="$(var.QtDir)\plugins\platforms\qwindows.dll"/>
              </Component>
            </Directory>
            <Directory Id="imageFormatPlugins" Name="imageformats">
              <Component Id="ImageFormatPlugins" Guid="{b42f7686-2c33-4f93-abb0-d43290cde3e4}">
                <File Id="qgif_dll" Source="$(var.QtDir)\plugins\imageformats\qgif.dll"/>
                <File Id="qjpeg_dll" Source="$(var.QtDir)\plugins\imageformats\qjpeg.dll"/>
                <File Id="qtga_dll" Source="$(var.QtDir)\plugins\imageformats\qtga.dll"/>
                <File Id="qtiff_dll" Source="$(var.QtDir)\plugins\imageformats\qtiff.dll"/>
                <File Id="qwbmp_dll" Source="$(var.QtDir)\plugins\imageformats\qwbmp.dll"/>
                <File Id="qwebp_dll" Source="$(var.QtDir)\plugins\imageformats\qwebp.dll"/>
              </Component>
            </Directory>
          </Directory>

          <Directory Id="dir674F7F6D2030C2EBF39AA06B57EAF368" Name="translations">
            <Component Id="Translations" Guid="{d031ae6a-3f46-403f-a0c9-77be2bd6fcb5}">
              <!--jmbde translations -->
              <File Id="fil3C525D5A74BC448FF36832F8D3438CB9" Source="$(var.InstallRoot)\translations\jmbde_ar_DZ.qm" />
              <File Id="filAB72AFE09E98BEA6DB799EEC31066C72" Source="$(var.InstallRoot)\translations\jmbde_bg.qm" />
              <File Id="filE9E184FF20DEF09116F8BF274094E369" Source="$(var.InstallRoot)\translations\jmbde_cs.qm" />
              <File Id="filFACF36529196967E4CFA6391EBDD5CF6" Source="$(var.InstallRoot)\translations\jmbde_de.qm" />
              <File Id="fil5D0F7497E05278ABCA30DE9CE4F56E77" Source="$(var.InstallRoot)\translations\jmbde_en.qm" />
              <File Id="filC018335544F53B73675E2FB664EC5FD3" Source="$(var.InstallRoot)\translations\jmbde_es.qm" />
              <File Id="fil594E5E839EC4145E8B4B931A2C493B0A" Source="$(var.InstallRoot)\translations\jmbde_fr.qm" />
              <File Id="filB841080212B940E99F0A87530E861878" Source="$(var.InstallRoot)\translations\jmbde_he.qm" />
              <File Id="fil4F6A21C501F8FD2F62A48F9F675562F0" Source="$(var.InstallRoot)\translations\jmbde_it.qm" />
              <File Id="fil474CB8EA4ACE7F46CDE67A76BD4C7898" Source="$(var.InstallRoot)\translations\jmbde_ja.qm" />
              <File Id="filB8359F4627FE4AF698E2DECFCB44C230" Source="$(var.InstallRoot)\translations\jmbde_nb.qm" />
              <File Id="fil3D78804A5164D3A538A69CC410748489" Source="$(var.InstallRoot)\translations\jmbde_nl.qm" />
              <File Id="fil2093FF1FA956B072F088284F7E8D9EB0" Source="$(var.InstallRoot)\translations\jmbde_pl.qm" />
              <File Id="filE804DB50B5E2D66789D32FE2DAC6B890" Source="$(var.InstallRoot)\translations\jmbde_pt.qm" />
              <File Id="fil3C89A9D825948C24FA8369978AFFA7A8" Source="$(var.InstallRoot)\translations\jmbde_pt_PT.qm" />
              <File Id="fil0EAEEC884057A18ABC38BE695E59BEF9" Source="$(var.InstallRoot)\translations\jmbde_ru.qm" />
              <File Id="filD4EFD29BBA084142AFB9E6486027D04C" Source="$(var.InstallRoot)\translations\jmbde_tr.qm" />
              <File Id="fil69C6C852D465D530C36403B014136302" Source="$(var.InstallRoot)\translations\jmbde_zh.qm" />
              <File Id="fil36A85C97B3C872B1AF9E53D0F5DC0FE6" Source="$(var.InstallRoot)\translations\jmbde_zh_TW.qm" />

              <!-- Qt translations -->
              <File Id="qt_de" Source="$(var.QtDir)\translations\qt_de.qm"/>
              <File Id="qt_es" Source="$(var.QtDir)\translations\qt_es.qm"/>
              <File Id="qt_it" Source="$(var.QtDir)\translations\qt_fr.qm"/>
            </Component>
          </Directory>
          </Directory>
        </Directory>
      </Directory>

      <Directory Id="ProgramMenuFolder" Name="Programs">
        <Component Id="ProgramMenuDir" Guid="{f8696c9f-a925-44b2-9374-8530a230267d}">
          <RegistryValue Root='HKMU' Key='Software\[Manufacturer]\[ProductName]' Type='string' Value='' KeyPath='yes' />
        </Component>
      </Directory>

      <Directory Id="DesktopFolder" Name="Desktop" />
    </Directory>

    <Feature Id='Complete' Level='1' Title="jmbde" Description="The complete package." ConfigurableDirectory='INSTALLDIR' AllowAdvertise='no' Absent='disallow'>
      <ComponentRef Id='MainExecutable' />
      <ComponentRef Id='Plugins' />
      <ComponentRef Id='Translations' />
      <ComponentRef Id='ProgramMenuDir' />
    </Feature>

    <!-- Set up ARPINSTALLLOCATION property (http://blogs.technet.com/b/alexshev/archive/2008/02/09/from-msi-to-wix-part-2.aspx) -->
    <CustomAction Id="SetARPINSTALLLOCATION" Property="ARPINSTALLLOCATION" Value="[INSTALLDIR]" />
    <CustomAction Id='LaunchApplication' FileKey='JMBDEEXE' ExeCommand='' Return='asyncNoWait' />

    <Property Id="WIXUI_INSTALLDIR">INSTALLDIR</Property>
    <UIRef Id="WixUI_InstallDir" />
    <UIRef Id="WixUI_ErrorProgressText" />

    <Icon Id="jmbde.exe" SourceFile="$(var.InstallRoot)\jmbde.exe" />

    <WixVariable Id="WixUILicenseRtf" Value="$(var.RootDir)\dist\win\gpl-2.0.rtf" />
    <WixVariable Id="WixUIBannerBmp" Value="$(var.RootDir)\dist\win\banner.bmp" />
    <WixVariable Id="WixUIDialogBmp" Value="$(var.RootDir)\dist\win\dialog.bmp" />

    <InstallExecuteSequence>
      <!-- Determine the install location after the install path has been validated by the installer -->
      <Custom Action="SetARPINSTALLLOCATION" After="InstallValidate"></Custom>
      <Custom Action='LaunchApplication' After='InstallFinalize'>NOT Installed</Custom>
    </InstallExecuteSequence>

  </Product>
</Wix>
