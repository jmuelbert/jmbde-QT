language: cpp
sudo: required
dist: xenial
python: 3.6
env:
  global:
  - secure: "phAkW9nYVFAxY1ue/kiNc4mtud+VdT7XB/6h9lSjsdDZcJNyR62KYKwLDxFlTdbgwj88JQ+ovTtf638POml5+n+kSYJMYBB0dj7dxbek4GECUA8gobCvTaBMP1hS0qIfWAp35ZESUspq1KfXC+DrvH3K+IqIxHAJiWAC1p5pYUinFA3eRjUqYOAzVJnHtEQ6K0P0Z6RxafcBqd6KzWfPJH7tuoPX+Rl+C5J3wAZzshrw0cYzh/Et42c7dU9J/cHdXdji7nXzNkYUripVZPqSDhcJ7iF65USkDJQZGEEQ+eAmsHys/ApRMd6UCQrqr+uiBjjPf3JdQcyLaBsDJQF2fzRNe1S4JqWdFvXeUjggB+lcGV/MKrL78nW8blANsFy1dalYmMX7opJS1OWXMIrJrG8IDenj5fyIhFq4h3XY+USlEPKaHpCPl3rZDlSxMnpqt47tvxNXYxayR0jDHgO2nRamhQ0ILE8EGnTZugeIJG2J9bYOlawUW/XSvLwUeLQPnNPn213w5eZSsupjJ7W3w7q8RNPxcgybYp21DPx3/nxhQeKRqssjhM344JKouMx6o5IRkT5UpkiZxEW1dJ6IiAZ+ioVenW1QNJc6CXs35JB+cQG33gnLt8vCUcTTMCz6Cnzp+xdyLe4yDxRm5IB+eLSBqaNfNsvbYWxol2pyIJs="

before_install:
  - echo -n | openssl s_client -connect https://scan.coverity.com:443 | sed -ne '/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p' | sudo tee -a /etc/ssl/certs/ca-

addons:
  coverity_scan:
    project:
      name: jmuelbert/jmbde-QT
      description: A little BDE Tool
    notification_email: juergen.muelbert@gmail.com
    build_command_prepend: qmake
    build_command: make
    branch_pattern: master

matrix:
  include:
  - os: linux
    compiler: gcc

    addons:
      apt:
        sources:
        - ubuntu-toolchain-r-test
    package:
      - binutils
      - g++7
      - libgl1-mesa-dev
      - zlib1g-dev

    env:
    - MATRIX="CC=gcc-7 && CXX=g++-7"

    before_install:
      - eval "${MATRIX_EVAL}"

      # Qt 5.12.3
      - sudo add-apt-repository --yes ppa:beineri/opt-qt-5.12.3-xenial

      # Update
      - sudo apt-get update -qq

    install:

      # Qt 5.12.3
      - sudo qpt-get install --yes qt512base
      - sudo qpt-get install --yes qt512script
      - sudo qpt-get install --yes qt512svg
      - sudo qpt-get install --yes qt512imageformats
      - sudo qpt-get install --yes qt512tools

      # Qbs 1.13
      - source /opt/qt512/bin/qt512-env.sh
      - source ./dist/linux/setup-qbs.sh

    script:
      - qbs --version
      - qbs setup-toolchains --detect
      - qbs setup-qt --detect
      - qbs config defaultProfile qt-5-12-3
      - qbs install --install-root jmbde/usr config:release projects.JMBde.version:$JMBDE_VERSION
      - cp LICENSE* *md jmbde/

    after_success:
      - wget -c "https://github.com/probonopd/linuxdeployqt/releases/download/continuous/linuxdeployqt-continuous-x86_64.AppImage" -O linuxdeployqt
      - chmod a+x linuxdeployqt
      - unset QTDIR; unset QT_PLUGIN_PATH; unset LD_LIBRARY_PATH
      - "./linuxdeployqt ./jmbde/usr/share/applications/io.github.jmuelbert.jmbde.desktop -bundle-non-qt-libs -extra-plugins=imageformats/libqsvg.so -exclude-libs=libpython3.54m.so.1.0 -verbose=2"
      - ./linuxdeployqt --appimage-extract
      - export PATH=${readlink -f ./squashfs-root/usr/bin/}:$PATH
      - ./squashfs-root/usr/bin/appimagetool jmbde/
      - find ./jmbde -executable -type f -exec ldd {} \; | grep " => /usr" | cut -d " " -f 2-3 | sort | uniq
      - mv jmbde-x86_64.AppImage jmbde-$JMBDE_VERSION-x86_64.AppImage

    deploy:
    - provider: releases
      skip_cleanup: true
      draft: true
      tag_name: "$TRAVIS_TAG"
      api_key:
        secure: pNq/95/zTpPX25pAF3ACjoIQAnvxp6xZQYCgKhKkXhuSMCSBMl7ZIrRw0BNuM1JSHe3bRV68pfF3tgTJDWtDjFj/JHAWDOAKWhc1DeEmBXVESoizaY2Hk4yrnxjFfk+XMOFgqO+iMExap4OW+kZWXP3tltjKUYzBROMU33rey6NBiYne+UNVlzC5vgy47mj7ResrS4YBl/s3nifuE9Bigp4yDYHh4/4UgXCLXuFup+PwYRQPfwZKKiac5Bk3nHXxW+8WK3b6anboyHb+eqdZMqtu5xjqOpjwroGPPuUQsRm7c4hT93yx3IIBoIHl29hdhkWJlCOQxdhnbV0Ch9E4gombkwfHGlTFAwD3SQZFkCLdtF+1hbMgp4jta09hLgSobOIHhpGjqw+CxB5epYCM7E3WC6iKSrE7yMiSEqg6V+cf3LV+B2MlSzr1HtwLe6B7542WhFoJiF0mJCCGt//Ztp2m5174s4ZwvsiXqYMgs5x5kyp1HS5NqqllxmL3dDdPlhscKWLr7zbwDG/hhDfUpfpjefmadwf6BramK66En7fe2iol/supO86alL6/WNpCtyFaTLve/DHtWfDt+XquivGZwzCAz+0XyopJc3E7Ebxi8C49dyvdrQRi+ej1s44Cm1l/qCtS90d3WyqSfp8moepbi4pwd08vw/TD5zi8+x4=
      file: j*.AppImage
      file_glob: true
      on:
        repo: jmuelbert/jmbde-QT
        tags: true

  - os: linux
    compiler: clang
    addons:
      apt:
        packages:
        - binutils
        - cppcheck
        - libgl1-mesa-dev
        - xvfb
        - zlib1g-dev
    
    env:
    - QMAKESPEC=linux-clang
    - MAKEFLAGS=-j2
 
    before_install:
      # Qt 5.12.3
      - sudo add-apt-repository --yes ppa:beineri/opt-qt-5.12.3-xenial

      # Update
      - sudo apt-get update -qq

    install:
     # Qt 5.12.3
      - sudo qpt-get install --yes qt512base
      - sudo qpt-get install --yes qt512script
      - sudo qpt-get install --yes qt512svg
      - sudo qpt-get install --yes qt512imageformats
      - sudo qpt-get install --yes qt512tools
    
    script:
      - qmake
      - make
      - pushd tests/
      - qmake
      - make
      - for test in `find -executable -type f`; do pushd `dirname $test`; xvfb-run -a ./`basename $test`||exit 1; popd; done
      - popd
    
    after_success:
      - echo "All success."
    
    after_script:
      - cppcheck --enable=all -q -Isrc/libjmbde `git ls-files src/\*.cpp`
  
  - os: osx
    env:
      - INSTALLER_NAME="qt-opensource-mac-x64-5.12.3"
      - QT_CI_PACKAGES="qt.qt5.5123.clang_64"

    before_install:
      - brew update
      - brew install qbs
      - curl -L https://raw.githubusercontent.com/benlau/qtci/master/bin/extract-qt-installer --output extract-qt-installer
      - chmod +x extract-qt-installer
      - curl -L https://download.qt.io/official_releases/qt/5.11/5.11.2/${INSTALLER_NAME}.dmg --output ${INSTALLER_NAME}.dmg
      - hdiutil attach ${INSTALLER_NAME}.dmg - "./extract-qt-installer /Volumes/${INSTALLER_NAME}/${INSTALLER_NAME}.app/Contents/MacOS/${INSTALLER_NAME} $HOME/Qt"
      - hdiutil detach /Volumes/${INSTALLER_NAME}
    
    script:
      - qbs --version
      - qbs setup-toolchains --detect
      - qbs setup-qt $HOME/Qt/5.12.3/clang_64/bin/qmake qt
      - qbs config profiles.qt.baseProfile xcode-macosx-x86_64
      - qbs config defaultProfile qt
      - qbs install --install-root install config:release project.JMBde.version:$JMBDE_VERSION
      - "$HOME/Qt/5.11.2/clang_64/bin/macdeployqt install/jmbde.app/Contents/MacOS/jmbde -appstore-compliant"
      - pushd install
      - ruby ../dist/mac/fixup-install-names.rb
      - popd

    deploy:
      - provider: releases
        skip_cleanup: true
        draft: true
        api_key:
          secure: pNq/95/zTpPX25pAF3ACjoIQAnvxp6xZQYCgKhKkXhuSMCSBMl7ZIrRw0BNuM1JSHe3bRV68pfF3tgTJDWtDjFj/JHAWDOAKWhc1DeEmBXVESoizaY2Hk4yrnxjFfk+XMOFgqO+iMExap4OW+kZWXP3tltjKUYzBROMU33rey6NBiYne+UNVlzC5vgy47mj7ResrS4YBl/s3nifuE9Bigp4yDYHh4/4UgXCLXuFup+PwYRQPfwZKKiac5Bk3nHXxW+8WK3b6anboyHb+eqdZMqtu5xjqOpjwroGPPuUQsRm7c4hT93yx3IIBoIHl29hdhkWJlCOQxdhnbV0Ch9E4gombkwfHGlTFAwD3SQZFkCLdtF+1hbMgp4jta09hLgSobOIHhpGjqw+CxB5epYCM7E3WC6iKSrE7yMiSEqg6V+cf3LV+B2MlSzr1HtwLe6B7542WhFoJiF0mJCCGt//Ztp2m5174s4ZwvsiXqYMgs5x5kyp1HS5NqqllxmL3dDdPlhscKWLr7zbwDG/hhDfUpfpjefmadwf6BramK66En7fe2iol/supO86alL6/WNpCtyFaTLve/DHtWfDt+XquivGZwzCAz+0XyopJc3E7Ebxi8C49dyvdrQRi+ej1s44Cm1l/qCtS90d3WyqSfp8moepbi4pwd08vw/TD5zi8+x4=
        file: j*.dmg
        file_glob: true
      
        on:
          repo: jmuelbert/jmbde-QT
          tags: true

    before_script:
      - if [[ "$TRAVIS_TAG" ]]; then export JMBDE_RELEASE=true ; fi
      - if [[ "$TRAVIS_TAG" ]]; then export JMBDE_VERSION=${TRAVIS_TAG:1} ; fi
      - if [[ "$TRAVIS_TAG" == "" ]]; then export JMBDE_VERSION=$(date "+%Y.%m.%d") ; fi
      - if [[ "$TRAVIS_BRANCH" == "snapshot" ]]; then export JMBDE_SNAPSHOT=true ; fi
