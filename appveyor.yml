clone_depth: 200
version: 1.0.{build}

cache:
  - C:\Users\appveyor\.m2
  - C:\ProgramData\chocolatey\bin -> appveyor.yml
  - C:\ProgramData\chocolatey\lib -> appveyor.yml

environment:
  my_secret:
    secure: NuyAKQY3nsfYHO6P59pRQCWMFPBYGuShNyCwrBWLuqK7jQ/CmRNZeuWuVRUvy/xU
  matrix:
    - GENERATOR: "Visual Studio 15 2017 Win64"
      APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2017
      QTDIR: C:\Qt\5.12.2\msvc2017_64
      PLATFORM: x64
    - GENERATOR: "Visual Studio 15 2017"
      APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2017
      QTDIR: C:\Qt\5.12.2\msvc2017
      PLATFORM: Win32

configuration: Release

init:
  - set PATH=%PATH%;%QTDIR%\bin;%WIX%\bin;
  - set VCINSTALLDIR="%ProgramFiles(x86)%\Microsoft Visual Studio\2017\BuildTools\VC"
install:
  - choco install -y qbs --version 1.12.1
  - nuget install secure-file -ExcludeVersion
  - choco install -y wixtoolset

before_build:
  - FOR /F "tokens=*" %%i in ('git describe') do SET COMMITNOW=%%i
  - set VERSION_DATE=%DATE:~10,4%.%DATE:~4,2%.%DATE:~7,2%
  - if defined APPVEYOR_REPO_TAG_NAME (set JMBDE_RELEASE=true) else (set JMBDE_SNAPSHOT=true)
  - if defined JMBDE_RELEASE set JMBDE_VERSION=%APPVEYOR_REPO_TAG_NAME:~1%
  - if defined JMBDE_RELEASE echo Building JMBDE %JMBDE_VERSION%... (from %COMMITNOW%)
  - if defined JMBDE_SNAPSHOT set JMBDE_VERSION=%APPVEYOR_BUILD_VERSION%
  - if defined JMBDE_SNAPSHOT echo Building JMBDE snapshot %JMBDE_VERSION%... (from %COMMITNOW%)

  - qbs --version
  - qbs setup-toolchains --detect
  - qbs setup-qt %QTDIR%\bin\qmake.exe qt
  - qbs config defaultProfile qt

build_script:
  - qbs build --all-products config:release

after_build:
  - cd Release\install-root
  - windeployqt jmbde.exe
  - dir
  - dir translations
  - candle.exe -arch %PLATFORM% -ext WixUIExtension -ext WixUtilExtension ../../dist/win/redist_vc140_%PLATFORM%.wxs -dInstallRoot=.  
  - candle.exe -arch %PLATFORM% -ext WixUIExtension -ext WixUtilExtension ../../dist/win/installer.wxs  -dInstallRoot=. -dQtDir=%QTDIR% -dRootDir=../../ -dVersion=%JMBDE_VERSION% -dPlatform=%PLATFORM%
  - light.exe -ext WixUIExtension -ext WixUtilExtension installer.wixob redist_vc140_%PLATFORM%.wixobj -out jmbde-%JMBDE_VERSION%-win_%MY_PLATFORM%.msi
  - move jmbde-*.msi %APPVEYOR_BUILD_FOLDER%

artifacts:
  - name: Installer
    path: "jmbde-*.msi"
  - name: Archive
    path: "jmbde-*.7z"

deploy:
  - provider: GitHub
    release: $(APPVEYOR_REPO_TAG_NAME)
    auth_token:
      secure: NuyAKQY3nsfYHO6P59pRQCWMFPBYGuShNyCwrBWLuqK7jQ/CmRNZeuWuVRUvy/xU
    artifact: /.*\.msi/
    draft: true
    on:
      appveyor_repo_tag: true
      push_release: true
